/* game_fixed.js - simplified optimized Phaser Tetris with audio-friendly splash */
const FIRST_RUN_KEY='tfa_first_run_shown_v2';
function tryPlayAudio(el){return el.play().then(()=>true).catch(()=>false);}
function showSplashThenStart(){const shown=localStorage.getItem(FIRST_RUN_KEY);const splash=document.getElementById('splash');const canvas=document.getElementById('logoCanvas');const ctx=canvas.getContext('2d');const logo=new Image();logo.src='assets/obomsoft_logo_512.png';const soundID=new Audio('assets/sound_id.wav');const mus=[new Audio('assets/music1.wav'), new Audio('assets/music2.wav'), new Audio('assets/music3.wav')];mus.forEach(a=>a.loop=false);function proceed(){splash.style.display='none';document.getElementById('gameContainer').style.display='block';if(!shown) localStorage.setItem(FIRST_RUN_KEY,'1');startGame();}logo.onload=async ()=>{ctx.clearRect(0,0,canvas.width,canvas.height);const w=canvas.width*0.9,h=canvas.height*0.7;ctx.drawImage(logo,(canvas.width-w)/2,(canvas.height-h)/2,w,h);if(shown){proceed();return;}const ok1=await tryPlayAudio(soundID);const ok2=await tryPlayAudio(mus[0]);if(!ok1||!ok2){const btn=document.createElement('button');btn.id='playBtn';btn.textContent='Tocar Ã¡udio / Iniciar';btn.style.position='absolute';btn.style.left='50%';btn.style.top='75%';btn.style.transform='translate(-50%,-50%)';btn.style.padding='12px 18px';btn.style.zIndex=9999;document.body.appendChild(btn);btn.onclick=async ()=>{await tryPlayAudio(soundID);await tryPlayAudio(mus[0]);btn.remove();animateIntro();};let t0=performance.now();function anim(t){const dt=(t-t0)/1000;ctx.clearRect(0,0,canvas.width,canvas.height);const g=ctx.createLinearGradient(0,0,0,canvas.height);g.addColorStop(0,'#8fd3f4');g.addColorStop(1,'#f6a6ff');ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.globalAlpha=0.98;ctx.drawImage(logo,(canvas.width-w)/2,(canvas.height-h)/2,w,h);ctx.fillStyle='rgba(255,255,255,'+(0.06+0.04*Math.sin(dt*4))+')';ctx.fillRect(canvas.width*0.2,canvas.height*0.45,canvas.width*0.6,6*Math.abs(Math.sin(dt*3)));requestAnimationFrame(anim);}requestAnimationFrame(anim);}else{animateIntro();}};function animateIntro(){let start=performance.now();function frame(t){const dt=(t-start)/1000;ctx.clearRect(0,0,canvas.width,canvas.height);const g=ctx.createLinearGradient(0,0,0,canvas.height);g.addColorStop(0,'#8fd3f4');g.addColorStop(1,'#f6a6ff');ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);const w=canvas.width*0.9,h=canvas.height*0.7;ctx.drawImage(document.querySelector('img[src*=\"obomsoft_logo_512.png\"]')||logo,(canvas.width-w)/2,(canvas.height-h)/2,w,h);for(let i=0;i<24;i++){const x=(canvas.width*0.15)+((i*37)%canvas.width)*0.9;const y=(canvas.height*0.2)+((i*23)%canvas.height)*0.6*Math.abs(Math.sin(dt+i));ctx.fillStyle='rgba(255,240,200,'+(0.45*Math.abs(Math.sin(dt+i))+0.1)+')';ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill();}ctx.fillStyle='rgba(255,255,255,'+(0.08*Math.abs(Math.sin(dt*4)))+')';ctx.fillRect(canvas.width*0.2,canvas.height*0.45,canvas.width*0.6,6*Math.abs(Math.sin(dt*3)));if(dt<3)requestAnimationFrame(frame);else{const splash=document.getElementById('splash');splash.style.display='none';document.getElementById('gameContainer').style.display='block';localStorage.setItem(FIRST_RUN_KEY,'1');startGame();}}requestAnimationFrame(frame);}}
function startGame(){document.getElementById('openPanel').addEventListener('click',()=>document.getElementById('sidePanel').classList.remove('hidden'));document.getElementById('closePanel').addEventListener('click',()=>document.getElementById('sidePanel').classList.add('hidden'));document.getElementById('toggleMusic').addEventListener('click',()=>{const a=window._tfa_bgm; if(a){ if(a.paused) a.play().catch(()=>{}); else a.pause(); }});document.getElementById('toggleTheme').addEventListener('click',()=>document.body.classList.toggle('dark'));const config={type:Phaser.AUTO,parent:'game',width:320,height:640,backgroundColor:'#071127',scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},scene:{preload,create,update}};const game=new Phaser.Game(config);let grid=Array.from({length:20},()=>Array(10).fill(0));let current=null;let dropTimer=0;let dropInterval=800;let score=0;function preload(){this.load.image('bg1','assets/bg_1.png');this.load.image('bg2','assets/bg_2.png');this.load.image('bg3','assets/bg_3.png');this.load.image('block','assets/obomsoft_logo_512.png');this.load.audio('music1','assets/music1.wav');this.load.audio('music2','assets/music2.wav');this.load.audio('music3','assets/music3.wav');}function create(){this.add.image(160,320,'bg1').setDisplaySize(320,640);const mus1=new Audio('assets/music1.wav'),mus2=new Audio('assets/music2.wav'),mus3=new Audio('assets/music3.wav');mus1.volume=0.5;mus2.volume=0.5;mus3.volume=0.5;window._tfa_bgm=mus1;mus1.play().catch(()=>{});mus1.addEventListener('ended',()=>{mus2.play().catch(()=>{});window._tfa_bgm=mus2});mus2.addEventListener('ended',()=>{mus3.play().catch(()=>{});window._tfa_bgm=mus3});mus3.addEventListener('ended',()=>{mus1.play().catch(()=>{});window._tfa_bgm=mus1});this.add.text(10,10,'Tetris For All',{font:'20px Arial',fill:'#ffffff'});this.add.text(10,34,'Score: 0',{font:'16px Arial',fill:'#ffffff'}).setName('scoreText');spawnPiece();this.gridGraphics=this.add.graphics();this.input.keyboard.on('keydown',(e)=>{if(e.key==='ArrowLeft') movePiece(-1);if(e.key==='ArrowRight') movePiece(1);if(e.key==='ArrowDown') dropPiece();if(e.key==='ArrowUp') rotatePiece();});}function update(time,delta){dropTimer+=delta;if(dropTimer>dropInterval){current.y+=1;dropTimer=0;}if(current.y>=20){lockPiece();clearLines();spawnPiece();}renderGrid(this);}function spawnPiece(){current={x:4,y:0,w:2,h:2,shape:[[1,1],[1,1]]};}function movePiece(dir){current.x=Math.max(0,Math.min(10-current.w,current.x+dir));}function dropPiece(){current.y+=1;}function rotatePiece(){}function lockPiece(){for(let ry=0;ry<current.h;ry++)for(let rx=0;rx<current.w;rx++)if(current.shape[ry][rx]){const gx=current.x+rx,gy=current.y+ry;if(gy>=0&&gy<20&&gx>=0&&gx<10)grid[gy][gx]=1;}}function clearLines(){for(let y=19;y>=0;y--){if(grid[y].every(v=>v===1)){grid.splice(y,1);grid.unshift(Array(10).fill(0));score+=100;const scoreText=this.scene.scenes[0].children.getByName('scoreText');if(scoreText)scoreText.setText('Score:'+score);}}}function renderGrid(scene){const g=scene.gridGraphics;g.clear();g.fillStyle(0xffcc00,1);for(let y=0;y<20;y++)for(let x=0;x<10;x++)if(grid[y][x])g.fillRect(16+x*32,16+y*32,30,30);g.fillStyle(0x66ccff,1);for(let ry=0;ry<current.h;ry++)for(let rx=0;rx<current.w;rx++)if(current.shape[ry][rx])g.fillRect(16+(current.x+rx)*32,16+(current.y+ry)*32,30,30);}}
showSplashThenStart();